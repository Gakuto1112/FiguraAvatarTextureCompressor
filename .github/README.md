# FiguraAvatarTextureCompressor
[Minecraft](https://www.minecraft.net) JavaEditionで利用可能なプレイヤースキンを変更するModである「[Figura](https://modrinth.com/mod/figura)」で使用できるアバターに含まれているテクスチャを圧縮するワークフローを提供します。

自分のFiguraアバターを他のFiguraプレイヤーからも見えるようにするには、専用のバックエンドサーバーへアバターをアップロードする必要があります。
しかし、そのバックエンドサーバーには、「1つのアバターにつき**100KB**まで」という制限があります。
凝ったアバターを製作するとすぐにアバターが100KBを超えそうになります。
特に、カスタムサウンドやテクスチャ画像が多くの容量を占めます。

このレポジトリが提供するワークフローをアバターレポジトリに組み込むことで、テクスチャが更新される度にテクスチャの圧縮処理を自動で実行します。
圧縮されたテクスチャは[GitHub Actions](https://github.co.jp/features/actions)によって自動的にコミット及びプッシュされるため、テクスチャをプッシュしてから暫く経った後、プル（`git pull`）するだけで圧縮されたテクスチャが手元のアバターに反映されます。

## 圧縮の仕組み
テクスチャの圧縮には「[pngquant](https://github.co.jp/features/actions)」を使用します。
pngquantでは、png画像のカラーモードをフルカラーからインデックスカラーに変更し、パレットも最適化することでpng画像のファイルサイズを50%～75%ほど減らします[^1]。

> [!IMPORTANT]
> 画像内で使用されている色数が256色を超える場合、256色に収まるように画像の色数が減らされます。
> 大なり小なり画像に劣化が生じますので、色数が多い画像の圧縮後は必ず確認してください。
> なお、マインクラフトのテクスチャは低解像度であることが多いので、256色を超えるケースは多くありません。

## ワークフローの動作
[テンプレートワークフロー](https://github.com/Gakuto1112/FiguraAvatarTextureCompressor/blob/main/workflow_templates/compress_textures.yml)では、「push」イベントでワークフローがトリガーされるようになっています。
ワークフローがトリガーされると、次の手順でワークフローが実行されます。

1. 指定されたテクスチャとモデルのパスが存在するか確認する。
   - もし指定されたパスが存在しなければ、この時点でワークフローの実行が中止されます。
2. 指定されたテクスチャパス内にある全てのpng画像に対して、圧縮処理を実行する。
   - 色数が256色を超えるpng画像に対しては警告メッセージが表示されます。
   - 圧縮処理を行った結果、元の画像のファイルサイズを超えてしまった場合、画像は置換されません。
3. 指定されたモデルパス内にある全てのbbmodelファイルに対して、埋め込まれたテクスチャデータを圧縮したものに置き換える。
4. 変更をコミットし、プッシュする。

## ワークフローの使用条件
このレポジトリのワークフローをそのまま使用するには、以下の条件を満たす必要があります。

- 全てのモデルファイルが1つのディレクトリに格納されている。
  - サブディレクトリへの格納は許可されています。
- 全てのテクスチャファイルが1つのディレクトリに格納されている。
  - サブディレクトリへの格納は許可されています。

## ワークフローへの入力引数
### target_branch
任意、string

圧縮を行う対象となるブランチ名を指定します。
省略した場合、レポジトリのデフォルトブランチが対象となります。

### textures_path
任意、string

アバターのテクスチャが格納されたディレクトリを指定します。
省略した場合、`textures/`になります。

### models_path
任意、string

アバターのモデルが格納されたディレクトリを指定します。
省略した場合、`modelss/`になります。

> [!NOTE]
> `textures_path`と`models_path`のデフォルト値は[こちらのアバターテンプレート](https://github.com/Gakuto1112/FiguraAvatarTemplate)に準拠しています。

## ワークフローの呼び出し
これらのワークフローを自身のレポジトリで呼び出したい場合、`workflow_templates/`内にあるワークフローファイルを自身のレポジトリの`.github/workflows/`に追加してください。

ワークフローの呼び出し部分と処理のコア部分は別々になっているため、ワークフローがシンプルになります。
 また、コア部分のアップデートも随時適用されます。

[^1]: 画像によってはファイルサイズの軽減幅が小さくなる場合もあります。
